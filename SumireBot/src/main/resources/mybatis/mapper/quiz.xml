<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="tokyo.sumire.repository.QuizRepository">
	<resultMap type="tokyo.sumire.domain.Quiz" id="quizInfo">
		<id column="QUIZ_ID" property="quizId" />
		<result column="QUESTION" property="question" />
		<collection property="choices"
			ofType="tokyo.sumire.domain.Choice">
			<result column="NAME" property="name" />
			<result column="CHOICE_ID" property="choiceId" />
			<result column="IMAGE_URI" property="imageUri" />
			<result column="BUST" property="bust" />
			<result column="WEST" property="west" />
			<result column="HIP" property="hip" />
		</collection>
	</resultMap>

	<select id="getQuiz" resultMap="quizInfo" parameterType="string">
		SELECT
			Q.QUIZ_ID AS QUIZ_ID,
			Q.QUESTION AS QUESTION,
			A.NAME AS NAME,
			C.CHOICE_ID AS CHOICE_ID,
			A.IMAGE_URI AS IMAGE_URI,
			A.BUST AS BUST,
			A.WEST AS WEST,
			A.HIP AS HIP
		FROM
			TBL_QUIZ AS Q
		INNER JOIN TBL_CHOICE AS C
			ON Q.QUIZ_ID = C.QUIZ_ID
		INNER JOIN TBL_ACTRESS AS A
			ON C.ACTRESS_ID = A.ACTRESS_ID
		WHERE
			Q.PLAN_DAY = #{planDay} AND
			Q.DELIVERIED_FLG = '0';
	</select>

	<select id="getResourceUri" parameterType="tokyo.sumire.domain.Answer" resultType="string">
		SELECT
			V.RESOURCE_URI
		FROM
			TBL_QUIZ AS Q
		INNER JOIN TBL_CHOICE AS C
			ON Q.QUIZ_ID = C.QUIZ_ID
		INNER JOIN TBL_ACTRESS AS A
			ON C.ACTRESS_ID = A.ACTRESS_ID
		INNER JOIN TBL_VIDEO AS V
			ON A.ACTRESS_ID = V.ACTRESS_ID
		WHERE
			Q.QUIZ_ID = #{quizId} AND
			C.CHOICE_ID = #{choiceId}
		ORDER BY
			RAND()
		LIMIT 1;
	</select>

	<select id="validateAnswer" parameterType="tokyo.sumire.domain.Answer" resultType="boolean">
		SELECT
			CASE WHEN COUNT(*) = 0 THEN TRUE ELSE FALSE END
		FROM
			TBL_QUIZ
		WHERE
			QUIZ_ID = #{quizId} AND
			DATE_FORMAT(PLAN_DAY, '%Y-%m-%d') = DATE_FORMAT(now(), '%Y-%m-%d');
	</select>

	<update id="updateDeliveriedFlg" parameterType="string">
		UPDATE
			TBL_QUIZ
		SET
			DELIVERIED_FLG = '1'
		WHERE
			QUIZ_ID = #{quizId};
	</update>

	<select id="checkAnswer" parameterType="tokyo.sumire.domain.Answer" resultType="boolean">
		SELECT
			C.CORRECT_FLG AS CORRECT_FLG
		FROM
			TBL_QUIZ AS Q
		INNER JOIN TBL_CHOICE AS C
			ON Q.QUIZ_ID = C.QUIZ_ID
		WHERE
			Q.QUIZ_ID = #{quizId} AND
			C.CHOICE_ID = #{choiceId};
	</select>

	<select id="checkRegistedAnswer" parameterType="tokyo.sumire.domain.Answer" resultType="boolean">
		SELECT
			CASE WHEN COUNT(*) > 0 THEN TRUE ELSE FALSE END
		FROM
			TBL_ANSWERED_HISTORY
		WHERE
			USER_ID = #{userId} AND
			QUIZ_ID = #{quizId};
	</select>

	<insert id="registAnswer" parameterType="tokyo.sumire.domain.Answer" >
		INSERT INTO TBL_ANSWERED_HISTORY (
			QUIZ_ID,
			CHOICE_ID,
			USER_ID
		) VALUES (
			#{quizId},
			#{choiceId},
			#{userId}
		);
	</insert>
</mapper>